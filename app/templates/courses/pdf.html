{% extends "layout.html" %}

{% block title %}{{ pdf.title }} | {{ course.title }} | Modular Course Platform{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('courses.index') }}">Courses</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('courses.view', course_id=course.id) }}">{{ course.title }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ pdf.title }}</li>
    </ol>
</nav>

<div class="container py-4">
    <div class="row">
        <!-- PDF Viewer Column -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">{{ pdf.title }}</h4>
                    <a href="{{ url_for('courses.pdf_file', pdf_id=pdf.id) }}" class="btn btn-sm btn-outline-primary" download>
                        <i class="bi bi-download"></i> Download PDF
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="pdf-container">
                        <iframe src="{{ url_for('courses.pdf_file', pdf_id=pdf.id) }}" width="100%" height="800px" style="border: none;"></iframe>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">PDF Document</small>
                        </div>
                        <div>
                            <a href="{{ url_for('courses.view', course_id=course.id) }}" class="btn btn-primary btn-sm">
                                Back to Course <i class="bi bi-arrow-left"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">About This Document</h5>
                </div>
                <div class="card-body">
                    <p>{{ pdf.description }}</p>
                </div>
            </div>
        </div>
        
        <!-- Course Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Course Materials</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for course_pdf in pdfs %}
                    <a href="{{ url_for('courses.view_pdf', course_id=course.id, pdf_id=course_pdf.id) }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                       {% if course_pdf.id == pdf.id %}active{% endif %}">
                        <div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-file-pdf me-2 {% if course_pdf.id == pdf.id %}text-white{% else %}text-danger{% endif %}"></i>
                                {{ course_pdf.title }}
                            </div>
                        </div>
                        
                        {% if course_pdf.id == pdf.id %}
                        <span class="badge bg-white text-primary">Current</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Course Videos</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for video in videos %}
                    <a href="{{ url_for('courses.video', course_id=course.id, video_id=video.id) }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center">
                                <span class="badge rounded-pill bg-secondary text-white me-2">{{ video.sequence_order }}</span>
                                {{ video.title }}
                            </div>
                            <small class="text-muted">{{ (video.duration_seconds / 60)|round|int }} minutes</small>
                        </div>
                        
                        {% if video.id in video_progress and video_progress[video.id].is_completed %}
                        <i class="bi bi-check-circle-fill text-success"></i>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <a href="{{ url_for('courses.view', course_id=course.id) }}" class="btn btn-outline-primary w-100">
                        Back to Course
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .pdf-container {
        width: 100%;
        height: 800px;
        overflow: hidden;
    }
    
    .pdf-container iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    @media (max-width: 768px) {
        .pdf-container {
            height: 500px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mark PDF as viewed after 10 seconds
        setTimeout(function() {
            fetch('{{ url_for("courses.complete_pdf", course_id=course.id, pdf_id=pdf.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    console.log('PDF marked as completed');
                }
            })
            .catch(error => console.error('Error marking PDF as completed:', error));
        }, 10000);
    });
</script>
{% endblock %}